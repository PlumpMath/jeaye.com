#!/usr/bin/env bash

cleanup()
{
  [ -z ${tmp+x} ] || rm -rf "$tmp"
}
trap cleanup EXIT

./generate-sprite-sheet

export JEKYLL_ENV=production
bundle exec jekyll build

for img in _site/img/*.png;
do
  optipng -q "$img"
done

tmp=$(mktemp -d)
cp -r _site/* "$tmp"/
cp -r .git "$tmp"/
pushd "$tmp"
  git checkout -B gh-pages
  git add .
  git commit -am "Publish updates"
  git push -f origin HEAD
popd
